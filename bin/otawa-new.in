#!/bin/bash

project=
template=program.mk
modules=
plugin=

# display help
function display_help {
	echo "SYNTAX: otawa-new <project name> <modules>..."
	echo "OPTIONS:"
	echo "	-p|--program  Generate a program makefile (default)."
	echo "	-l|--loader	  Generate a loader plugin makefile."
	echo "	-i|--ilp	  Generate an ilp plugin makefile."
	echo "	-r|--proc	  Generate a processor plugin makefile."
	exit 1
}


# Scan arguments
for arg in $*; do
	case "$arg" in
	-p|--program)
		template=program.mk
		plugin=
		;;
	-l|--loader)
		template=loader.mk
		plugin=loader
		;;
	-i|--ilp)
		template=plugin.mk
		plugin=ilp
		;;
	-r|--proc)
		template=plugin.mk
		plugin=proc
		;;
	-*|--*)
		echo "ERROR: unknown option \"$arg\""
		display_help
		;;
	*)
		if test -z "$project"; then
			project="$arg"
		else
			modules="$modules $arg"
		fi
		;;
	esac
done
if test "$project" = ""; then
	display_help
fi


# Perform the processing
exec=$project
if test -n "$plugin"; then
	exec="$project.la"
fi
if test -e "$project"; then
	echo "ERROR: '$project' already exists."
	exit 1
fi
mkdir $project
cd $project
sed -e "s/@PROJECT@/$exec/" \
	-e "s/@MODULES@/$modules/" \
	-e "s/@PLUGIN@/$plugin/" @prefix@/share/Otawa/makefiles/$template \
	> Makefile
