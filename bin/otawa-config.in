#!@BASH_PATH@

# find the prefix
prefix=`readlink -f "$0"`
prefix=`dirname $prefix`/..
if [ ! -d "$prefix/lib/libotawa.so" ]; then
	prefix="@prefix@"
fi


# Initialization
option=
cflags=
libs=
data=
doc=
ilp=
loader=
list_proc=
list_modules=
cflags_text="-I$prefix/include"
libs_text="$prefix/lib/libotawa.la"


# Configurations
#	KIND: kind of module (one of lib, ilp, loader)
#	DOC: module documentation
#	LIB: special link options
#	LIB_STATIC: special option for static link

function config_display {
	KIND="lib"
	DOC="graph displayer"
}

function config_gensim {
	KIND="lib"
	DOC="generic temporal simulator"
}

function config_lp_solve {
	KIND="ilp"
	DOC="lp_solve 4.x ILP solver"
}

function config_lp_solve5 {
	KIND="ilp"
	DOC="lp_solve 5.x ILP solver"
}

function config_ppc {
	KIND="loader"
	DOC="PowerPC architecture loader"
}

function config_arm {
	KIND="loader"
	DOC="ARM architecture loader"
}

function config_bpred {
	KIND="proc"
	DOC="branch prediction"
}
function config_ets {
	KIND="proc_otawa"
	DOC="Extended Timing Schema"
	REQUIRE="ast"
}

function config_ast {
	KIND="proc_otawa"
	DOC="Abstract Syntactic Tree"
}


# Compute the module list
modules="display ast ets"
@HAS_SYSTEMC_TRUE@		modules="$modules gensim"
@HAS_LP_SOLVE_TRUE@		modules="$modules lp_solve"
@HAS_LP_SOLVE5_TRUE@	modules="$modules lp_solve5"
@HAS_GLISS_PPC_TRUE@	modules="$modules ppc"
@HAS_GLISS_ARM_TRUE@	modules="$modules arm"
@HAS_ILP_TRUE@			modules="$modules bpred"
module_done=""


# use a module ($1: module, $2: static)
function use_module {
	mod="$1"
	#echo "use_module($1)"
	
	# test already done
	if [ `expr match "$modules" ".*$mod.*"` == 0 ]; then
		echo "ERROR: unknown module $mod"
		exit 1
	fi
	if [ `expr match "$module_done" ".*$mod.*"` != 0 ]; then
		#echo "$1 already done !"
		return
	fi
	
	# configure the module
	KIND=""
	LIB=""
	STATIC_LIB=""
	REQUIRE=""
	config_$mod
	
	# setup the module
	if [ "$2" = yes ]; then
		if [ -z "$LIB_STATIC" ]; then
			case "$KIND" in
			ilp)
				LIB_STATIC="-u${mod}_plugin $prefix/lib/otawa/ilp/$mod.la"
				;;
			loader)
				LIB_STATIC="-u${mod}_plugin $prefix/lib/otawa/loader/$mod.la"
				;;
			lib)
				LIB_STATIC="$prefix/lib/libo$mod.la"
				;;
			proc)
				LIB_STATIC="$prefix/lib/otawa/proc/$mod.la"
				;;
			proc_otawa)
				LIB_STATIC="$prefix/lib/otawa/proc/otawa/$mod.la"
				;;
			esac
		fi
		libs_text="$libs_text $LIB_STATIC "
	else
		if [ -z "$LIB" ]; then
			case "$KIND" in
			ilp)
				LIB="-u${mod}_plugin $prefix/lib/otawa/ilp/$mod.la"
				;;
			loader)
				LIB="-u${mod}_plugin $prefix/lib/otawa/loader/$mod.la"
				;;
			lib)
				LIB="$prefix/lib/libo$mod.la"
				;;
			proc)
				LIB="$prefix/lib/otawa/proc/$mod.la"
				;;
			proc_otawa)
				LIB="$prefix/lib/otawa/proc/otawa/$mod.la"
				;;
			esac
			fi
			libs_text="$libs_text $LIB "
	fi

	# handle the requirements
	module_done="$module_done $mod"
	for require in $REQUIRE; do
		use_module $require $2
	done	
}

# Decode options
while test "$1" != ""; do
	case "$1" in
	--cflags)
		cflags=ok
		option=ok
		;;
	--libs)
		libs=ok
		option=ok
		;;
	--data)
		data=ok
		option=ok
		;;
	--doc)
		doc=ok
		option=ok
		;;
	--has-so)
		exit @HAS_SO@
		;;
	--version)
		echo "@PACKAGE@ @VERSION@"
		exit 1
		;;
	--help|-h)
		;;
	--ilp)
		option=ok
		ilp=ok
		;;
	--loader)
		option=ok
		loader=ok
		;;
	--modules)
		option=ok
		list_modules=ok
		;;
	--proc)
		option=ok
		list_proc=ok
		;;
	--prefix)
		echo "$prefix"
		exit 0
		;;
	-*)
		echo "ERROR: unknown option '$1'."
		exit 1
		;;
	+*)
		use_module "${1#+}" yes
		;;
	*)
		use_module $1 no
		;;
	esac
	shift
done

# Check options
if test "$option" == ""; then
	echo "SYNTAX: otawa-config [-h|--help] [--cflags] [--libs] [--data] [+]modules..."
	echo "	--cflags: display required compilation flags."
	echo "	--data: display path to package data."
	echo "	--doc: display path to the auto-documentation."
	echo "	--has-so: exit 0 if OTAWA is a shared object, false else."
	echo "	--ilp: list ILP solver plugins available."
	echo "	--libs: display required libs."
	echo "	--loader: list loader plugins available."
	echo "	--modules: list available modules."
	echo "  --prefix: get the prefix of installation."
	echo "	--proc: list available processor collections."
	echo "	+module: Link module statically, even if we have plugins."
	echo "Modules may be:"
	for mod in $modules; do
		DOC=""
		config_$mod
		echo "	$mod -- $DOC"
	done
	exit
fi

# Perform display
if test "$cflags" == "ok"; then
	echo $cflags_text
fi
if test "$libs" == "ok"; then
	echo $libs_text
fi
if test "$data" == "ok"; then
	echo $prefix/share/Otawa
fi
if test "$doc" == "ok"; then
	echo $prefix/share/Otawa/autodoc/index.html
fi

# --ilp
if [ "$ilp" == "ok" ]; then
	one="no"
	paths="$prefix/lib/otawa/ilp $HOME/.otawa/ilp $PWD/.otawa/ilp"
	for path in $paths; do
		if [ -d "$path" ]; then
			for plugin in `cd $path; ls *.so`; do
				echo "${plugin%*.so} ($path)"
				one="yes"
			done
		fi
	done
	if [ "$one" == "no" ]; then
		echo "no plugin found in [$paths]"
	fi
fi

# --loader
if [ "$loader" == "ok" ]; then
	one="no"
	paths="$prefix/lib/otawa/loader $HOME/.otawa/loader $PWD/.otawa/loader"
	for path in $paths; do
		if [ -d "$path" ]; then
			for plugin in ` cd $path; ls *.so`; do
				echo "${plugin%*.so} ($path)"
				one="yes"
			done
		fi
	done
	if [ "$one" == "no" ]; then
		echo "no plugin found in [$paths]"
	fi
fi

# --proc
if [ "$list_proc" == "ok" ]; then
	one="no"
	paths="$prefix/lib/otawa/proc $HOME/.otawa/proc $PWD/.otawa/proc"
	for path in $paths; do
		if [ -d "$path" ]; then
			for plugin in `cd $path; ls *.la`; do
				echo "${plugin%*.la} ($path)"
				one="yes"
			done
		fi
	done
	if [ "$one" == "no" ]; then
		echo "no plugin found in [$paths]"
	fi
fi

# --modules
if [ "$list_modules" == "ok" ]; then
	for module in $modules; do
		DOC=""
		config_$module
		echo "[$module]"
		echo "	$DOC"
	done
fi
